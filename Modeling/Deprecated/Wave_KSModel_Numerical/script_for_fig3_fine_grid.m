% clear all;
%  load('D:\Dropbox\Yale\paper_wave_diversity\manuscript\Figures\final figure May2016\fig2\fig2_data_20180115.mat')
dx=5;
%  final_profile=fig2_data.wave_final_profile;
cell_density=sum(final_profile.cell_density);
[denmax,denmaxind]=max(cell_density(600:end));
 denmaxind=denmaxind+599;
 wavedensity=sum(cell_density((400+denmaxind-400):end));
 cell_number=wavedensity*(dx*6*8.4/10*1.4);
   dyn_den_end=final_profile.cell_density(:,:);
  [phenotypemax,phenotypemaxind]=max(dyn_den_end');
  x=0:dx:(2200-1)*dx;
  x=x-(denmaxind-1)*dx;
  x=x/1000;
  yyaxis left;
  plot(x,sum(dyn_den_end)*8.4*10^8,'DisplayName','cell_density');
  hold on;
CWBias_exp=[0,0.0100000000000000,0.0200000000000000,0.0300000000000000,0.0400000000000000,0.0500000000000000,0.0600000000000000,0.0700000000000000,0.0800000000000000,0.0900000000000000,0.100000000000000,0.110000000000000,0.120000000000000,0.130000000000000,0.140000000000000,0.150000000000000,0.160000000000000,0.170000000000000,0.180000000000000,0.190000000000000,0.200000000000000,0.210000000000000,0.220000000000000,0.230000000000000,0.240000000000000,0.250000000000000,0.260000000000000,0.270000000000000,0.280000000000000,0.290000000000000,0.300000000000000,0.310000000000000,0.320000000000000,0.330000000000000,0.340000000000000,0.350000000000000,0.360000000000000,0.370000000000000,0.380000000000000,0.390000000000000,0.400000000000000,0.410000000000000,0.420000000000000,0.430000000000000,0.440000000000000,0.450000000000000,0.460000000000000,0.470000000000000,0.480000000000000,0.490000000000000,0.500000000000000,0.510000000000000,0.520000000000000,0.530000000000000,0.540000000000000,0.550000000000000,0.560000000000000,0.570000000000000,0.580000000000000,0.590000000000000,0.600000000000000,0.610000000000000,0.620000000000000,0.630000000000000,0.640000000000000,0.650000000000000,0.660000000000000,0.670000000000000,0.680000000000000,0.690000000000000,0.700000000000000];
P_exp=[0,0.00302823490236943,0.00498640060510877,0.00740654246062159,0.0129576724735464,0.0282364445536801,0.0342746634745129,0.0605832532805051,0.0797351468975508,0.105863629784042,0.144957679208212,0.222281447976504,0.281608928805501,0.373987712933409,0.512065751136908,0.691152325282671,0.919556834551468,1.19485305314468,1.51155357679430,1.88448868628358,2.26163802431774,2.67050119556754,3.04502589236555,3.42156794182481,3.78827243915744,4.11858437055020,4.26770099008759,4.46704480752076,4.50323811436766,4.50544966346908,4.42742856648661,4.31612752213579,4.11316467718262,3.94529362322380,3.65109481682462,3.23848249620281,2.98678093597204,2.69627429599337,2.36626462681502,2.10807472740901,1.95992530735338,1.71658120173055,1.53144380527692,1.43826939988074,1.27455605283792,1.14836389445003,1.01135546697596,0.907225653941910,0.780385038989034,0.685196631521439,0.645362573778435,0.620271119730271,0.579787157033761,0.525204939995039,0.523233085565830,0.466362640857505,0.445131198472857,0.399401650650870,0.399447904195710,0.371516048640824,0.380986255044554,0.393076006538824,0.375160618566594,0.357271202286408,0.341376560968248,0.322917046544370,0.291493170711647,0.311004430859554,0.290374229335908,0.272975724047314,0.162176873861474];
dCWBias=0.001;CWBias=0.001:dCWBias:CWBias_exp(end);
P=interp1(CWBias_exp,P_exp,CWBias,'spline');P=P./sum(P)./dCWBias;
  plot(x,sum(dyn_den_end(abs(CWBias-0.15)<0.05,:))*8.4*10^8);
  plot(x,sum(dyn_den_end(abs(CWBias-0.25)<0.05,:))*8.4*10^8);
  plot(x,sum(dyn_den_end(abs(CWBias-0.35)<0.05,:))*8.4*10^8);
  plot(x,sum(dyn_den_end(abs(CWBias-0.45)<0.05,:))*8.4*10^8);
  Ki=3.5;      %uM
Ka=1000;    %uM
N=6;
ASP_profile=final_profile.asp;
 f=N*log((1+ASP_profile/Ki)./(1+ASP_profile/Ka));
 yyaxis right
 plot(x,f);
 ylim([0 30]);
 gradient=((f(3:end)-f(1:end-2))/2/dx)*1000;
 [maxgrad,maxgradind]=max(gradient);
 plot((x(1:end-2)+x(3:end))/2,gradient);
 plot([x(maxgradind) x(maxgradind)],[0 50],'--');
 xlim([-1.5 1.5]);
 %% gradient over space
 figure;
yyaxis right;
 xlim([-3 1]);ylim([0.3 30]);ylabel('gradient mm^{-1}');xlabel('space mm')
semilogy((x(1:end-2)+x(3:end))/2,gradient);hold on;
semilogy([x(maxgradind) x(maxgradind)],[0.0001 15^10]);ylim([0.3 30]);
 % chi over space
 hold on;
yyaxis left
   x=0:dx:(2200-1)*dx;
den_profile=final_profile.cell_density(:,1:end);
[denmax,denmaxind]=max(sum(den_profile(:,600:end)));
denmaxind=599+denmaxind;
[phenotypemax,phenotypemaxind]=max(den_profile(:,(denmaxind-600):end)');
x=x-(denmaxind-1)*dx; 
x=x/1000;
X_max=x(phenotypemaxind+denmaxind-600);
CWBias_exp=[0,0.0100000000000000,0.0220000000000000,0.0300000000000000,0.0400000000000000,0.0500000000000000,0.0600000000000000,0.0700000000000000,0.0800000000000000,0.0900000000000000,0.100000000000000,0.110000000000000,0.122000000000000,0.130000000000000,0.140000000000000,0.150000000000000,0.160000000000000,0.170000000000000,0.180000000000000,0.190000000000000,0.220000000000000,0.210000000000000,0.222000000000000,0.230000000000000,0.240000000000000,0.250000000000000,0.260000000000000,0.270000000000000,0.280000000000000,0.290000000000000,0.300000000000000,0.310000000000000,0.322000000000000,0.330000000000000,0.340000000000000,0.350000000000000,0.360000000000000,0.370000000000000,0.380000000000000,0.390000000000000,0.400000000000000,0.410000000000000,0.422000000000000,0.430000000000000,0.440000000000000,0.450000000000000,0.460000000000000,0.470000000000000,0.480000000000000,0.490000000000000,0.500000000000000,0.510000000000000,0.522000000000000,0.530000000000000,0.540000000000000,0.550000000000000,0.560000000000000,0.570000000000000,0.580000000000000,0.590000000000000,0.600000000000000,0.610000000000000,0.622000000000000,0.630000000000000,0.640000000000000,0.650000000000000,0.660000000000000,0.670000000000000,0.680000000000000,0.690000000000000,0.700000000000000];
P_exp=[0,0.00302823490236943,0.00498640060510877,0.00740654246062159,0.0129576724735464,0.0282364445536801,0.0342746634745129,0.0605832532805051,0.0797351468975508,0.105863629784042,0.144957679208212,0.222281447976504,0.281608928805501,0.373987712933409,0.512065751136908,0.691152325282671,0.919556834551468,1.19485305314468,1.51155357679430,1.88448868628358,2.26163802431774,2.67050119556754,3.04502589236555,3.42156794182481,3.78827243915744,4.11858437055020,4.26770099008759,4.46704480752076,4.50323811436766,4.50544966346908,4.42742856648661,4.31612752213579,4.11316467718262,3.94529362322380,3.65109481682462,3.23848249620281,2.98678093597204,2.69627429599337,2.36626462681502,2.10807472740901,1.95992530735338,1.71658120173055,1.53144380527692,1.43826939988074,1.27455605283792,1.14836389445003,1.01135546697596,0.907225653941910,0.780385038989034,0.685196631521439,0.645362573778435,0.620271119730271,0.579787157033761,0.525204939995039,0.523233085565830,0.466362640857505,0.445131198472857,0.399401650650870,0.399447904195710,0.371516048640824,0.380986255044554,0.393076006538824,0.375160618566594,0.357271202286408,0.341376560968248,0.322917046544370,0.291493170711647,0.311004430859554,0.290374229335908,0.272975724047314,0.162176873861474];
dCWBias=0.001;CWBias=0.001:dCWBias:CWBias_exp(end);
P=interp1(CWBias_exp,P_exp,CWBias,'spline');P=P./sum(P)./dCWBias;
g1=28;g2=g1;
Kd      =  2.9;
w       =  3.8;
Yp=g2*Kd./(g2-g1/2+log(1./CWBias-1))-Kd;
deltaG  =  g1/4-g2/2*(Yp./(Kd+Yp));
lambdaT   =  w*exp(deltaG);
lambdaR  =  w*exp(-deltaG);
CWBias  =  ((lambdaR)./((lambdaT)+(lambdaR)));
 alpha=5.1138;
 a=Yp/alpha;
Drot=0.062*2;
v=28*4/pi;%2D run speed 26um/s
 theta=1-0.1564;
Diff=v^2*(1-CWBias)./3./(lambdaR*theta+Drot);
ki=22*Diff./(1+0.05./CWBias)/N;
ki=ki*10^-6*60;
semilogy(smooth(smooth(X_max(46:596))),smooth(ki(46:596)));
ylabel('\chi mm^2/min');
yyaxis right
yyaxis left
[cw01 cw01ind]=min(abs(CWBias-0.1));
plot(X_max(cw01ind),ki(cw01ind),'o');
[cw02 cw02ind]=min(abs(CWBias-0.2));
plot(X_max(cw02ind),ki(cw02ind),'o')
[cw03 cw03ind]=min(abs(CWBias-0.3));
plot(X_max(cw03ind),ki(cw03ind),'o')
[cw04 cw04ind]=min(abs(CWBias-0.4));
plot(X_max(cw04ind),ki(cw04ind),'o');
yyaxis right
gradientF=gradient(phenotypemaxind+denmaxind-600-1);

plot(X_max(cw01ind),gradientF(cw01ind),'o');

plot(X_max(cw02ind),gradientF(cw02ind),'o')

plot(X_max(cw03ind),gradientF(cw03ind),'o')

plot(X_max(cw04ind),gradientF(cw04ind),'o');

%% fig3d
figure;
ind_performance=smooth(smooth(gradientF(46:596).*ki(46:596)));


plot(smooth(X_max(46:596)),ind_performance(1:end));
hold on;
dt=0.005;
 peakpos=final_profile.peakpos;
 time=0:dt:(length(peakpos)-1)*dt;
 T=length(peakpos);
p=polyfit(time(peakpos>6.64),peakpos(peakpos>6.64),1);
p(1)*60
x=0:dx:(2200-1)*dx;
x=x-(denmaxind-1)*dx; 
plot(x/1000,ones(1,length(x)).*p(1)*60,'--');
xlim([-2 1]);
xlim([-2 1]);
% 
plot(X_max(cw01ind),ind_performance(cw01ind),'o');

plot(X_max(cw02ind),ind_performance(cw02ind),'o')

plot(X_max(cw03ind),ind_performance(cw03ind),'o')

plot(X_max(cw04ind),ind_performance(cw04ind),'o');
ylim([0 0.3]);
% plot(ones(1,100)*ddx(maxgradind),0:1:99);

%%
% plot(smooth(smooth(X_max(12:596))),smooth(ki(12:596)));
% hold on;
% mean_ki=sum(final_profile.cell_density.*repmat(ki,650,1)')./sum(final_profile.cell_density);
%  x=0:dx:(650-1)*dx;
%   x=x-(denmaxind-1)*dx;
% plot(x/1000,mean_ki);
% for i=1:700
%     mean_pos(i)=sum(x(200:end).*final_profile.cell_density(i,200:end))./sum(final_profile.cell_density(i,200:end));
% end
% plot(mean_pos(12:600)/1000,ki(12:600));
%%


plot(x/1000,(sum(final_profile.cell_density.*repmat(ki,2200,1)').*[0 gradient 0]-[0 sum((diff(final_profile.cell_density(:,2:end)')'+diff(final_profile.cell_density(:,1:end-1)')')/2.*repmat(Diff*10^-6*60,1998,1)')/dx*1000 0])./sum(final_profile.cell_density));
%%
% plot(smooth(ki(12:596)),smooth(smooth(X_max(12:596))));hold on;
% plot(ki(12:600),mean_pos(12:600)/1000);
% %%
% plot(CWBias(1:596),smooth(smooth(X_max(1:596))));
% hold on;
% plot(CWBias(1:596),mean_pos(1:596)/1000);