%%
[final_profile wavespeed dyn_profile dx] = chemo_oxygen_fun_v6(200,2000,2000);
%%
CWBias_exp=[0,0.0100000000000000,0.0200000000000000,0.0300000000000000,0.0400000000000000,0.0500000000000000,0.0600000000000000,0.0700000000000000,0.0800000000000000,0.0900000000000000,0.100000000000000,0.110000000000000,0.120000000000000,0.130000000000000,0.140000000000000,0.150000000000000,0.160000000000000,0.170000000000000,0.180000000000000,0.190000000000000,0.200000000000000,0.210000000000000,0.220000000000000,0.230000000000000,0.240000000000000,0.250000000000000,0.260000000000000,0.270000000000000,0.280000000000000,0.290000000000000,0.300000000000000,0.310000000000000,0.320000000000000,0.330000000000000,0.340000000000000,0.350000000000000,0.360000000000000,0.370000000000000,0.380000000000000,0.390000000000000,0.400000000000000,0.410000000000000,0.420000000000000,0.430000000000000,0.440000000000000,0.450000000000000,0.460000000000000,0.470000000000000,0.480000000000000,0.490000000000000,0.500000000000000,0.510000000000000,0.520000000000000,0.530000000000000,0.540000000000000,0.550000000000000,0.560000000000000,0.570000000000000,0.580000000000000,0.590000000000000,0.600000000000000,0.610000000000000,0.620000000000000,0.630000000000000,0.640000000000000,0.650000000000000,0.660000000000000,0.670000000000000,0.680000000000000,0.690000000000000,0.700000000000000,0.710000000000000,0.720000000000000,0.730000000000000,0.740000000000000,0.750000000000000,0.760000000000000,0.770000000000000,0.780000000000000,0.790000000000000,0.800000000000000,0.810000000000000,0.820000000000000,0.830000000000000,0.840000000000000,0.850000000000000,0.860000000000000,0.870000000000000,0.880000000000000,0.890000000000000,0.900000000000000];
P_exp=[0.559256540754102,0.617268493908312,0.681907816813149,0.734998671894103,0.778495118965288,0.840514050227151,0.890770106313650,0.982184670626720,1.09253769506987,1.20290997765837,1.29554550838617,1.40324861203016,1.48489544502537,1.54546231212839,1.65291891151199,1.78419783668460,1.90919090321733,2.07926728799749,2.28597266521960,2.46774259585189,2.61924642526347,2.74742478903590,2.84764417739968,2.87158975531889,2.86745695732833,2.84935815233519,2.82144154484631,2.75232020958203,2.69405276503294,2.63990656358720,2.63548104178743,2.63082057061448,2.61753630195704,2.61945056160411,2.56473817068529,2.39869829316898,2.21621966278808,2.04257666949044,1.83503934038952,1.68035791699637,1.57032072613684,1.45544203753814,1.32972871636959,1.21777341423392,1.08868606600132,0.976904087173732,0.881672558453724,0.800938561547755,0.739324051338090,0.686225492998998,0.630064889550407,0.579870459529005,0.536535780878700,0.489195407997097,0.448033048141456,0.427723408062969,0.414373661711359,0.407818189036679,0.394094834665420,0.368323584567722,0.320212885872409,0.275468510983012,0.228008737600285,0.196972310565873,0.187115991779442,0.206481982736134,0.218664685479972,0.237113988718347,0.263620899968139,0.294310680386380,0.296240346549726,0.307028759570747,0.322200326471783,0.316711755049093,0.298924932010509,0.300357738024011,0.292993423244935,0.265196216257178,0.254091969652535,0.246296272417781,0.233285469424204,0.226067516549733,0.236686457891738,0.233343243860232,0.227288482964465,0.218537581720709,0.201967873467788,0.178980067310299,0.135456658835634,0.0966801692085699,0];
dCWBias=0.005;CWBias=0.001:dCWBias:CWBias_exp(end);
P1=interp1(CWBias_exp,P_exp,CWBias,'spline');
P_exp=[1.23407523693263,2.28235067261608,3.16814072439635,4.02097757124949,4.78197831207942,5.48006838895755,6.09821498249095,6.53950534523820,6.86466461718851,6.95005958849459,6.76100463197052,6.33813881989921,5.75439769142952,5.01836899383535,4.28215352149304,3.58483778159158,2.93880727461703,2.38874785906202,1.92177207730486,1.48926791000138,1.15077759040255,0.883483470110528,0.652781635891708,0.483871114182710,0.398880821497601,0.324602838846467,0.274072487193284,0.252258753066705,0.243056205580198,0.205549501469230,0.184284418165314,0.168058361920606,0.152081338673419,0.147186283815903,0.164050487116758,0.171035084469096,0.182183202248733,0.201849026771696,0.193234041513714,0.175358141660432,0.165918234598163,0.154820701646147,0.136034274895680,0.139404002643381,0.148015096760777,0.158649583983028,0.171809421445762,0.188759229839514,0.186113254240857,0.182031447765869,0.173074042136297,0.154454934431038,0.135730765929951,0.133633441153957,0.134559532613487,0.131901883593071,0.138279463013952,0.139516845720383,0.132773499084393,0.129170302901515,0.130571113512569,0.121851067458759,0.115430685491428,0.108344918483847,0.0879242126871503,0.0675035068904534,0.0539584465096793,0.0419270398169607,0.0353198831014898,0.0422305487826891,0.0527521929279384,0.0699938368656603,0.0844455330030332,0.0975080919511109,0.102037379593518,0.0989945076550625,0.0869825566652752,0.0785154347495716,0.0754141957023217,0.0761184921484349,0.0799707213288332,0.0856245486006702,0.0947375998536931,0.0929048726375643,0.0908231124239147,0.0894728866404822,0.0856012017571526,0.0740639699188892,0.0628341381869403,0.0489440633408512,0.0263624774719173];
% P = lognpdf(CWBias,log(0.318),0.298)/sum(lognpdf(CWBias,log(0.318),0.298))/dCWBias;
% P1 = lognpdf(CWBias,log(0.17),0.65)/sum(lognpdf(CWBias,log(0.17),0.65))/dCWBias;
P2 = interp1(CWBias_exp,P_exp,CWBias,'spline');
%  PWT= [lognpdf(CWBias,log(0.318),0.298)/sum(lognpdf(CWBias,log(0.318),0.298))/dCWBias lognpdf(CWBias,log(0.318),0.298)/sum(lognpdf(CWBias,log(0.318),0.298))/dCWBias]/2;
CWBias=[CWBias CWBias];
P=[P1 P2]/2;
%      CWBias=[0.2 0.2];P=[0.5 0.5];dCWBias=1;
% CC=winter(length(CWBias));
dt=0.5;    %s
dx=50;      %um
%%
%     dt=0.5;    %s
% dx=50;      %um
g1=28;g2=g1;
Kd      =  2.9;
w       =  3.8;
Yp=g2*Kd./(g2-g1/2+log(1./CWBias-1))-Kd;
deltaG  =  g1/4-g2/2*(Yp./(Kd+Yp));
lambdaT   =  w*exp(deltaG);
lambdaR  =  w*exp(-deltaG);
CWBias  =  ((lambdaR)./((lambdaT)+(lambdaR)));
alpha=5.1138;
Drot=0.062*2;
v=28*4/pi;%2D run speed 26um/s
theta=1-0.1564;
Diff=v^2*(1-CWBias)./3./(lambdaR*theta+Drot);
ki=22*Diff./(1+0.05./CWBias);%.*(0.995./CWBias)./(1+0.995./CWBias);
%%
ASP_profile=final_profile.asp;
Ki=3.5;      %uM
Ka=1000;    %uM
N=6;
f=N*log((1+ASP_profile/Ki)./(1+ASP_profile/Ka));
gradient=((f(3:end)-f(1:end-2))/2/dx);
%%
den_pheno=final_profile.cell_density;
den_total=sum(den_pheno);
den_pheno_combined = squeeze(sum(reshape(den_pheno, 180, 2, 1000),2));
offset = 120;
[~,phenotypemaxind]=max(den_pheno_combined(:,offset:end)');
gradientF=gradient(phenotypemaxind+offset-1);
ki = ki(1:180);
CWBias = CWBias(1:180);
%%
x = dx:dx:400*dx;
figure
subplot(4,1,1)
plot(CWBias,ki)
xlabel('TB')
ylabel('\chi')
subplot(4,1,2)
plot(CWBias,gradientF)
xlabel('TB')
ylabel('f''')
subplot(4,1,3)
plot(CWBias,ki.*gradientF)
xlabel('TB')
ylabel('\chif''')
subplot(4,1,4)
plot(CWBias,phenotypemaxind*dx)
xlabel('TB')
ylabel('peak z')
%%
figure
scatter(phenotypemaxind*dx, ki.*gradientF, '.')
xlabel('x')
ylabel('\chif''')
xlim([10000 15000])
ylim([0 10])
% xlim([5000 6000])